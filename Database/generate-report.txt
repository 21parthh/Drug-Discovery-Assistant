import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
const geminiApiKey = Deno.env.get('GEMINI_API_KEY');
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
};
serve(async (req)=>{
  if (req.method === 'OPTIONS') {
    return new Response(null, {
      headers: corsHeaders
    });
  }
  if (!geminiApiKey) {
    return new Response(JSON.stringify({
      error: 'Gemini API key not configured'
    }), {
      status: 500,
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  }
  try {
    const { discoveryResult } = await req.json();
    if (!discoveryResult || !discoveryResult.targets) {
      return new Response(JSON.stringify({
        error: 'Invalid discovery result data'
      }), {
        status: 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    const prompt = `
Generate a comprehensive drug discovery research report based on the following data:

Disease: ${discoveryResult.disease_name}
Number of targets identified: ${discoveryResult.targets.length}
Total compounds analyzed: ${discoveryResult.targets.reduce((sum, target)=>sum + target.hits.length, 0)}

Target Details:
${discoveryResult.targets.map((target, index)=>`
${index + 1}. Target: ${target.symbol}
   - Ensembl ID: ${target.ensembl}
   - Association Score: ${target.score?.toFixed(3) || 'N/A'}
   - ChEMBL ID: ${target.chembl_target_id || 'Not found'}
   - Hit Compounds: ${target.hits.length}
   ${target.hits.slice(0, 3).map((hit, hitIndex)=>`
     Compound ${hitIndex + 1}:
     - ChEMBL ID: ${hit.molecule_chembl_id || 'Unknown'}
     - SMILES: ${hit.smiles || 'N/A'}
     - Bioactivity: ${hit.bioactivity.type || 'Unknown'} ${hit.bioactivity.value || ''} ${hit.bioactivity.units || ''}
     ${hit.analysis ? `- Molecular Weight: ${hit.analysis.MolWt}
     - LogP: ${hit.analysis.LogP}
     - Lipinski Violations: ${hit.analysis.Lipinski_violations}` : ''}
   `).join('')}
`).join('')}

Please create a detailed pharmaceutical research report with the following requirements:

FORMATTING REQUIREMENTS:
- Use clean markdown formatting without any asterisks or special characters for emphasis
- Use proper headings with ## and ###
- Use bullet points with - for lists
- Make it professional and clean

CONTENT REQUIREMENTS:
1. For each compound identified, explain:
   - What the drug/compound is used for in existing medicines
   - Which existing FDA-approved medications contain similar compounds
   - Why this compound is significant for treating ${discoveryResult.disease_name}

2. Clearly label and separate these sections:
   - TARGET IDENTIFICATION: Explain how targets were identified and their relevance
   - HIT DISCOVERY: Detail the compound screening process and results
   - COMPOUND ANALYSIS: Provide drug-likeness assessment and molecular properties

3. Include specific drug names and their current medical uses where applicable

REPORT SECTIONS:
## Executive Summary
## Target Identification Analysis
## Hit Discovery Results  
## Compound Analysis and Drug-likeness Assessment
## Existing Medicines and Drug Applications
## Key Findings and Therapeutic Potential
## Recommendations for Drug Development

Make the report detailed, scientific, and focused on practical pharmaceutical applications. Do not use any asterisks for formatting.
`;
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [
          {
            parts: [
              {
                text: prompt
              }
            ]
          }
        ],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 4096
        }
      })
    });
    if (!response.ok) {
      const errorData = await response.text();
      console.error('Gemini API error:', errorData);
      throw new Error(`Gemini API error: ${response.status}`);
    }
    const data = await response.json();
    const generatedReport = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!generatedReport) {
      throw new Error('No report generated from Gemini API');
    }
    return new Response(JSON.stringify({
      report: generatedReport,
      metadata: {
        disease: discoveryResult.disease_name,
        targets_count: discoveryResult.targets.length,
        compounds_count: discoveryResult.targets.reduce((sum, target)=>sum + target.hits.length, 0),
        generated_at: new Date().toISOString()
      }
    }), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  } catch (error) {
    console.error('Error in generate-report function:', error);
    return new Response(JSON.stringify({
      error: error instanceof Error ? error.message : 'Unknown error occurred'
    }), {
      status: 500,
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  }
});
